@page "/Budgets/{_BudgetId:int}"

@inject DataManager DataManager

<h1>Budget Name: @_Budget!.BudgetName.</h1>
<h2>
    Total Assets: $@DataManager.CalculateAssets(_Budget)
</h2>

<h2>
    Unassigned Assets: $@(DataManager.CalculateAssets(_Budget) - DataManager.CalculateAllAssignedAssets(_Budget))
</h2>

<button class="btn btn-primary col-md-3 mb-2" @onclick="async () => await _AddSectionCollapse.ToggleAsync()">Add a Section</button>

<div class="row mb-4">
    <Collapse @ref=_AddSectionCollapse OnHiding="() => UpdateState()">
        <Card class="col-md-7">
            <CardBody>
                <NewSection CollapseObj=_AddSectionCollapse />
            </CardBody>
        </Card>
    </Collapse>
</div>

<SectionTableData />

@code {
    [Parameter]
    public int _BudgetId { get; set; }

    private Collapse _AddSectionCollapse = default!;

    private Budget? _Budget;

    protected override void OnInitialized()
    {
        using(var context = new ApplicationDbContext())
        {
            _Budget = DataManager.BudgetAccountsTransactionsDictionary!.Keys.FirstOrDefault(x => x.BudgetId == _BudgetId)!;
            DataManager.CurrentBudget = _Budget;
            DataManager.GenerateCollapseComponents(_Budget);
        }
    }

    private void UpdateState()
    {
        DataManager.OrderLists();
        StateHasChanged();
    }
}
