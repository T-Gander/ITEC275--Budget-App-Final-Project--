@page "/"
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Home</PageTitle>

<h1>Hello @_FirstName, you're logged in!</h1>

<h3>Choose one of your existing budgets below, or create a new one:</h3>

<button class="btn btn-primary mb-4" @onclick=NewBudget>New Budget</button>

@* List all budgets *@
@foreach(Budget b in _BudgetList)
{
    <div class="row">
        <div class="col-md-3 align-content-center">
            <h3><strong>@b.BudgetName</strong></h3>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary" @onclick="() => ViewBudget(b.BudgetId)">View</button>
        </div>
    </div>
}


@code {
    private ClaimsPrincipal user;

    private string _FirstName;

    private string _UserId;

    private List<Budget> _BudgetList;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        user = authState.User;

        using(var context = new ApplicationDbContext())
        {
            User loggedInUser = context.Users.FirstOrDefault(x => x.Email == user.Identity.Name);
            _FirstName = loggedInUser.FirstName;
            _UserId = loggedInUser.Id;

            _BudgetList = context.Budgets.Where(x => x.UserId == _UserId).ToList();
        }
    }

    private void NewBudget()
    {
        NavigationManager.NavigateTo($"./NewBudget", true);
    }

    private void ViewBudget(int budgetId)
    {
        NavigationManager.NavigateTo($"./Budgets/{budgetId}", true);    
    }
}

