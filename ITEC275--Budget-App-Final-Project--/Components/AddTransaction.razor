@inject NavigationManager NavigationManager
@inject DataManager DataManager

<div id="newTransaction" class="row justify-content-around">
    <div class="row mb-2 justify-content-between">
        <label class="col-md-8">Transaction Date:</label>
        <input class="col-md-4" @bind-value=_NewTransaction.TransactionDate />
    </div>
    <div class="row mb-2 justify-content-between">
        <label class="col-md-8">Payee:</label>
        <input class="col-md-4" @bind-value=_NewTransaction.Payee />
    </div>
    <div class="row mb-2 justify-content-between">
        <label class="col-md-8">Category:</label>
        <select @bind=_NewTransaction.CategoryId>
            <option>Select a Value...</option>
            @foreach (List<Category> categoriesList in DataManager.BudgetSectionCategoriesDictionary![DataManager.CurrentBudget!].Values)
            {
                foreach(Category category in categoriesList)
                {
                    <option value="@category.CategoryId">@category.CategoryName</option>
                }
            }
        </select>
    </div>
    <div class="row mb-2 justify-content-between">
        <label class="col-md-8">Transaction Value:</label>
        <input class="col-md-4" @bind-value=_NewTransaction.TransactionValue /> 
    </div>
    <div class="row mb-2 justify-content-end">
        <button class="col-md-4 btn btn-primary" @onclick=AddNewTransaction>Add</button>
    </div>
</div>

@code {
    [Parameter]
    public Collapse CollapseObj { get; set; }

    [Parameter]
    public int _AccountId { get; set; }

    public Transaction _NewTransaction = new();

    protected override void OnInitialized()
    {
        _NewTransaction.TransactionDate = DateTime.Now;
    }

    private void AddNewTransaction()
    {
        using(var context = new ApplicationDbContext())
        {
            _NewTransaction.AccountId = _AccountId;

            if(_NewTransaction.CategoryId != null)
            {
                if (_NewTransaction.IsCredit)
                    context.Categories.FirstOrDefault(x => x.CategoryId == _NewTransaction.CategoryId).AssignedBudget += _NewTransaction.TransactionValue;
                else
                    context.Categories.FirstOrDefault(x => x.CategoryId == _NewTransaction.CategoryId).AssignedBudget -= _NewTransaction.TransactionValue;
            }

            Account _Account = DataManager.BudgetAccountsTransactionsDictionary![DataManager.CurrentBudget!].Keys.FirstOrDefault(x => x.AccountId == _AccountId)!;

            DataManager.BudgetAccountsTransactionsDictionary[DataManager.CurrentBudget!][_Account].Add(_NewTransaction);

            context.Transactions.Add(_NewTransaction);
            context.SaveChanges();
        }

        CollapseObj.ToggleAsync();
    }

}